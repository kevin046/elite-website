<!DOCTYPE html>
<html>
<head>
    <title>Create Invoice - Elite Renovation Works</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/M58mL0J/transparent-elite-home.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f6fa;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .company-logo {
            max-width: 300px;
            height: auto;
        }
        .back-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        .back-btn:hover {
            background: #2980b9;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .line-items {
            margin-bottom: 20px;
        }
        .line-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .submit-btn {
            background: #e74c3c;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        .submit-btn:hover {
            background: #c0392b;
        }
        .section-title {
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 8px;
            border-bottom: 2px solid #e74c3c;
        }
        .estimate-input-group {
            display: flex;
            gap: 10px;
        }
        .fetch-btn {
            background: #3498db;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .fetch-btn:hover {
            background: #2980b9;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <button onclick="goBack()" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <img src="https://i.ibb.co/M58mL0J/transparent-elite-home.png" alt="Elite Renovation Works Logo" class="company-logo">
            <h1 class="section-title">Create Invoice</h1>
        </div>

        <form id="invoiceForm">
            <div class="form-section">
                <h2 class="section-title">Invoice Details</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Invoice Number:</label>
                        <input type="text" name="invoiceNumber" readonly>
                    </div>
                    <div class="form-group">
                        <label>Estimate Number:</label>
                        <div class="estimate-input-group">
                            <input type="text" name="estimateNumber" placeholder="Enter estimate number">
                            <button type="button" onclick="fetchEstimateData()" class="fetch-btn">
                                Fetch Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Information -->
            <div class="form-section">
                <h2 class="section-title">Client Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Client Name:</label>
                        <input type="text" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Client Email:</label>
                        <input type="email" name="clientEmail" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Client Phone:</label>
                        <input type="tel" name="clientPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Street Address:</label>
                        <input type="text" name="clientStreet" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>City:</label>
                        <input type="text" name="clientCity" required>
                    </div>
                    <div class="form-group">
                        <label>Project Description:</label>
                        <textarea name="projectDescription" rows="3" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Line Items -->
            <div class="form-section">
                <h2 class="section-title">Cost Breakdown</h2>
                <div class="form-group">
                    <label>Payment Method:</label>
                    <select name="paymentMethod" id="paymentMethod" onchange="updateTaxCalculation()">
                        <option value="cash">Cash Payment (Tax Free)</option>
                        <option value="cash">E-Transfer (Tax Free)</option>
                        <option value="regular">Credit Card</option>
                        <option value="regular">Cheque</option>
                        <option value="regular">Bank Draft</option>
                    </select>
                </div>
                <div class="line-items" id="lineItems">
                    <div class="line-item">
                        <label>Description</label>
                        <label>Quantity</label>
                        <label>Unit Price</label>
                        <label>Amount</label>
                        <label></label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Subtotal:</label>
                        <input type="number" name="subtotal" readonly>
                    </div>
                    <div class="form-group">
                        <label>HST (13%):</label>
                        <input type="number" name="tax" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Total:</label>
                    <input type="number" name="total" readonly>
                </div>
            </div>

            <button type="submit" class="submit-btn">Generate Invoice</button>
        </form>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://nhcttofusmnzlertxjkq.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oY3R0b2Z1c21uemxlcnR4amtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI5NDA2MDYsImV4cCI6MjA0ODUxNjYwNn0.WA6rQWC5ISi5QiWOKbdf3wwrysBSMhEq5Lt_HXEDqEU'
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey)

        document.addEventListener('DOMContentLoaded', function() {
            // Check for estimate data
            const estimateData = JSON.parse(sessionStorage.getItem('invoiceFromEstimate'));
            if (estimateData) {
                populateFormFromEstimate(estimateData);
            }

            // Generate invoice number
            generateInvoiceNumber();
            
            // Set current date
            document.querySelector('[name="invoiceDate"]').value = new Date().toLocaleDateString();

            // Check for edit data
            const editData = sessionStorage.getItem('editEstimateData');
            if (editData) {
                const estimate = JSON.parse(editData);
                
                // Fill in form fields
                document.querySelector('[name="estimateNumber"]').value = estimate.estimate_number;
                document.querySelector('[name="clientName"]').value = estimate.client_name;
                document.querySelector('[name="clientEmail"]').value = estimate.client_email;
                document.querySelector('[name="clientPhone"]').value = estimate.client_phone;
                
                // Split address back into parts
                const [street, city] = estimate.client_address.split(', ');
                document.querySelector('[name="clientStreet"]').value = street;
                document.querySelector('[name="clientCity"]').value = city;
                
                document.querySelector('[name="projectDescription"]').value = estimate.project_description;
                document.getElementById('paymentMethod').value = estimate.payment_method;
                
                // Add line items
                estimate.line_items.forEach(item => {
                    const lineItem = document.createElement('div');
                    lineItem.className = 'line-item';
                    lineItem.innerHTML = `
                        <input type="text" name="description[]" value="${item.description}" required>
                        <input type="number" name="quantity[]" value="${item.quantity}" required>
                        <input type="number" name="unitPrice[]" value="${item.unit_price}" required>
                        <input type="number" name="amount[]" value="${item.amount}" readonly>
                        <button type="button" class="remove-item" onclick="this.parentElement.remove(); calculateTotals();">×</button>
                    `;
                    document.getElementById('lineItems').appendChild(lineItem);
                });
                
                // Update totals
                document.querySelector('[name="subtotal"]').value = estimate.subtotal;
                document.querySelector('[name="tax"]').value = estimate.tax;
                document.querySelector('[name="total"]').value = estimate.total;
                
                // Clear the stored data
                sessionStorage.removeItem('editEstimateData');
            }
        });

        function generateInvoiceNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            const randomNum = Math.floor(Math.random() * (9999 - 1000 + 1) + 1000);
            document.querySelector('[name="invoiceNumber"]').value = `INV-${year}${month}${day}-${randomNum}`;
        }

        function populateFormFromEstimate(data) {
            // Set estimate number
            document.querySelector('[name="estimateNumber"]').value = data.estimateNumber;

            // Populate client info
            // Add your code to populate client information

            // Populate line items
            // Add your code to populate line items

            // Set totals
            document.querySelector('[name="subtotal"]').value = data.subtotal;
            document.querySelector('[name="tax"]').value = data.tax;
            document.querySelector('[name="total"]').value = data.total;
        }

        function goBack() {
            window.location.href = 'admin-dashboard.html';
        }

        // Form submission handler
        document.getElementById('invoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Generating...';
            
            try {
                // Create PDF
                window.jsPDF = window.jspdf.jsPDF;
                const doc = new window.jsPDF();
                
                // Add company logo
                const img = new Image();
                img.src = 'https://i.ibb.co/M58mL0J/transparent-elite-home.png';
                
                img.onload = function() {
                    // Add logo with proper scaling
                    const imgWidth = 70;
                    const imgHeight = (img.height * imgWidth) / img.width;
                    doc.addImage(img, 'PNG', 15, 10, imgWidth, imgHeight);
                    
                    // Add company info in top right
                    doc.setFontSize(14);
                    doc.text('Elite Renovation Works', doc.internal.pageSize.width - 15, 20, { align: 'right' });
                    doc.setFontSize(9);
                    doc.text([
                        '6 Interlacken Way',
                        'Markham, Ontario L3R 5H9',
                        'Representative: Jay',
                        'Phone: 647-563-1314',
                        'Email: jay@eliterenovationworks.ca'
                    ], doc.internal.pageSize.width - 15, 25, { 
                        align: 'right',
                        lineHeightFactor: 1.5
                    });
                    
                    // Add invoice details with smaller font
                    doc.setFontSize(10);
                    doc.text('Invoice #: ' + document.querySelector('[name="invoiceNumber"]').value, 15, imgHeight + 25);
                    doc.text('Estimate #: ' + document.querySelector('[name="estimateNumber"]').value, 15, imgHeight + 32);
                    doc.text('Date: ' + new Date().toLocaleDateString(), doc.internal.pageSize.width - 15, imgHeight + 25, { align: 'right' });

                    // Add separator line
                    doc.setDrawColor(44, 62, 80);
                    doc.setLineWidth(0.5);
                    doc.line(15, imgHeight + 35, doc.internal.pageSize.width - 15, imgHeight + 35);

                    // Add client info
                    doc.setFontSize(11);
                    doc.text('Client Details:', 15, imgHeight + 50);
                    doc.setFontSize(10);
                    doc.text('Name: ' + document.querySelector('[name="clientName"]').value, 20, imgHeight + 60);
                    doc.text('Phone: ' + document.querySelector('[name="clientPhone"]').value, doc.internal.pageSize.width/2, imgHeight + 60);
                    doc.text('Email: ' + document.querySelector('[name="clientEmail"]').value, 20, imgHeight + 67);
                    doc.text('Address: ' + document.querySelector('[name="clientStreet"]').value + ', ' + 
                            document.querySelector('[name="clientCity"]').value, doc.internal.pageSize.width/2, imgHeight + 67);

                    // Add project description more compactly
                    doc.text('Project: ' + document.querySelector('[name="projectDescription"]').value, 20, imgHeight + 80);

                    // Add line items table
                    doc.autoTable({
                        startY: imgHeight + 90,
                        head: [['Description', 'Quantity', 'Unit Price', 'Amount']],
                        body: [...document.querySelectorAll('.line-item')].slice(1).map(item => [
                            item.querySelector('[name="description[]"]').value,
                            item.querySelector('[name="quantity[]"]').value,
                            '$' + item.querySelector('[name="unitPrice[]"]').value,
                            '$' + item.querySelector('[name="amount[]"]').value
                        ]),
                        foot: [
                            ['', '', 'Subtotal:', '$' + document.querySelector('[name="subtotal"]').value],
                            ['', '', 'Tax (13%):', '$' + document.querySelector('[name="tax"]').value],
                            ['', '', 'Total:', '$' + document.querySelector('[name="total"]').value]
                        ],
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [44, 62, 80],
                            fontSize: 11,
                            halign: 'center',
                            textColor: [255, 255, 255]
                        },
                        bodyStyles: { 
                            fontSize: 10,
                            lineColor: [200, 200, 200],
                            textColor: [44, 62, 80]
                        },
                        footStyles: { 
                            fillColor: [249, 249, 249],
                            fontSize: 10,
                            fontStyle: 'bold',
                            halign: 'right',
                            textColor: [44, 62, 80]
                        },
                        columnStyles: {
                            0: { cellWidth: 'auto' },
                            1: { cellWidth: 30, halign: 'center' },
                            2: { cellWidth: 40, halign: 'right' },
                            3: { cellWidth: 40, halign: 'right' }
                        }
                    });

                    // Add payment info
                    const finalY = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(10);
                    const paymentMethodSelect = document.getElementById('paymentMethod');
                    const paymentMethodText = paymentMethodSelect.options[paymentMethodSelect.selectedIndex].text;
                    doc.text('Payment Method: ' + paymentMethodText, 15, finalY);

                    // Add payment schedule disclaimer
                    doc.text('Payment Schedule & Terms:', 15, finalY + 10);
                    doc.setFontSize(9);
                    
                    // Calculate payment amounts
                    const totalAmount = parseFloat(document.querySelector('[name="total"]').value);
                    const firstPayment = Math.round(totalAmount / 3);
                    const secondPayment = Math.round(totalAmount / 3);
                    const finalPayment = totalAmount - firstPayment - secondPayment;
                    
                    doc.text([
                        `• 1st Payment: $${firstPayment.toFixed(2)} (Due upon signing)`,
                        `• 2nd Payment: $${secondPayment.toFixed(2)} (Due at 50% completion)`,
                        `• Final Payment: $${finalPayment.toFixed(2)} (Due upon completion)`
                    ], 20, finalY + 20, {
                        lineHeightFactor: 1.3
                    });
                    
                    // Add payment disclaimer in red
                    doc.setTextColor(231, 76, 60); // Red color for disclaimer
                    doc.text([
                        '* All payments due within 5 business days of milestone completion',
                        '* Work begins after receiving first payment and signed contract',
                        '* Price subject to change with scope modifications'
                    ], 20, finalY + 35, {
                        lineHeightFactor: 1.3
                    });
                    doc.setTextColor(0, 0, 0); // Reset to black color

                    // Add signature sections
                    const signatureY = finalY + 45;
                    doc.setDrawColor(100, 100, 100);
                    doc.setLineWidth(0.5);
                    
                    // Client signature section
                    doc.text('Client Authorization', 15, signatureY + 15);
                    doc.text('Print Name:', 15, signatureY + 25);
                    doc.text('_____________________________', 35, signatureY + 25);
                    doc.text('Signature:', 15, signatureY + 40);
                    doc.text('X', 32, signatureY + 40);
                    doc.text('_____________________________', 35, signatureY + 40);
                    doc.text('Date:', 15, signatureY + 55);
                    doc.text('_____________________________', 35, signatureY + 55);

                    // Representative signature section
                    doc.text('Representative Authorization', doc.internal.pageSize.width/2 + 15, signatureY + 15);
                    doc.text('Print Name:', doc.internal.pageSize.width/2 + 15, signatureY + 25);
                    doc.text('_____________________________', doc.internal.pageSize.width/2 + 35, signatureY + 25);
                    doc.text('Signature:', doc.internal.pageSize.width/2 + 15, signatureY + 40);
                    doc.text('X', doc.internal.pageSize.width/2 + 32, signatureY + 40);
                    doc.text('_____________________________', doc.internal.pageSize.width/2 + 35, signatureY + 40);
                    doc.text('Date:', doc.internal.pageSize.width/2 + 15, signatureY + 55);
                    doc.text('_____________________________', doc.internal.pageSize.width/2 + 35, signatureY + 55);

                    // Add GST/HST number if not cash payment
                    if (document.getElementById('paymentMethod').value !== 'cash') {
                        doc.text('GST/HST: 743299224RT0001', doc.internal.pageSize.width/2, doc.internal.pageSize.height - 10, {
                            align: 'center'
                        });
                    }

                   
                    // Save PDF
                    doc.save(`invoice-${document.querySelector('[name="invoiceNumber"]').value}.pdf`);
                    alert('Invoice generated successfully!');
                };
                
                img.onerror = function() {
                    throw new Error('Failed to load company logo');
                };
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate invoice. Please try again.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Generate Invoice';
            }
        });

        async function fetchEstimateData() {
            const estimateNumber = document.querySelector('[name="estimateNumber"]').value;
            if (!estimateNumber) {
                alert('Please enter an estimate number');
                return;
            }

            try {
                const { data: estimates, error } = await supabaseClient
                    .from('estimates')
                    .select('*')
                    .eq('estimate_number', estimateNumber)
                    .single();

                if (error) throw error;

                if (!estimates) {
                    alert('No estimate found with this number');
                    return;
                }

                // Fill in form fields
                document.querySelector('[name="clientName"]').value = estimates.client_name;
                document.querySelector('[name="clientEmail"]').value = estimates.client_email;
                document.querySelector('[name="clientPhone"]').value = estimates.client_phone;
                
                // Split address back into parts
                const [street, city] = estimates.client_address.split(', ');
                document.querySelector('[name="clientStreet"]').value = street;
                document.querySelector('[name="clientCity"]').value = city;
                
                document.querySelector('[name="projectDescription"]').value = estimates.project_description;
                document.getElementById('paymentMethod').value = estimates.payment_method;
                
                // Clear existing line items except header
                const lineItemsContainer = document.getElementById('lineItems');
                while (lineItemsContainer.children.length > 1) {
                    lineItemsContainer.removeChild(lineItemsContainer.lastChild);
                }

                // Add line items
                estimates.line_items.forEach(item => {
                    const lineItem = document.createElement('div');
                    lineItem.className = 'line-item';
                    lineItem.innerHTML = `
                        <input type="text" name="description[]" value="${item.description}" required>
                        <input type="number" name="quantity[]" value="${item.quantity}" required>
                        <input type="number" name="unitPrice[]" value="${item.unit_price}" required>
                        <input type="number" name="amount[]" value="${item.amount}" readonly>
                        <button type="button" class="remove-item" onclick="this.parentElement.remove(); calculateTotals();">×</button>
                    `;
                    lineItemsContainer.appendChild(lineItem);
                });
                
                // Update totals
                document.querySelector('[name="subtotal"]').value = estimates.subtotal;
                document.querySelector('[name="tax"]').value = estimates.tax;
                document.querySelector('[name="total"]').value = estimates.total;

                // Update tax display based on payment method
                updateTaxCalculation();

            } catch (error) {
                console.error('Error fetching estimate:', error);
                alert('Failed to fetch estimate data');
            }
        }

        // Add tax calculation function
        function updateTaxCalculation() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const taxSection = document.querySelector('[name="tax"]').parentElement;
            taxSection.style.display = paymentMethod === 'regular' ? 'block' : 'none';
            calculateTotals();
        }

        // Add calculate totals function
        function calculateTotals() {
            const amounts = [...document.getElementsByName('amount[]')].map(input => Number(input.value) || 0);
            const subtotal = amounts.reduce((sum, amount) => sum + amount, 0);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const tax = paymentMethod === 'regular' ? subtotal * 0.13 : 0;
            const total = subtotal + tax;

            document.querySelector('[name="subtotal"]').value = subtotal.toFixed(2);
            document.querySelector('[name="tax"]').value = tax.toFixed(2);
            document.querySelector('[name="total"]').value = total.toFixed(2);
        }
    </script>
</body>
</html> 