<!DOCTYPE html>
<html>
<head>
    <title>Generate Estimate - Elite Renovation Works</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/M58mL0J/transparent-elite-home.png">
    <style>
        body { 
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f6fa;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e74c3c;
        }
        .company-logo {
            max-width: 300px;
            height: auto;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }
        input, select, textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .line-items {
            margin-bottom: 20px;
        }
        .line-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .remove-item {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-item {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button[type="submit"] {
            background: #e74c3c;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            opacity: 0.9;
        }
        .section-title {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 8px;
        }
        .form-section .section-title {
            border-bottom: 2px solid #e74c3c;
        }
        .payment-method-note {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        .company-info-small {
            text-align: left;
            font-size: 0.9em;
            color: #666;
            margin-top: 15px;
            line-height: 1.4;
            padding-left: 20px;
        }
        .company-info-small p {
            margin: 2px 0;
        }
        .company-info-small strong {
            color: #2c3e50;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }

        /* Add print styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }

            .form-container {
                box-shadow: none;
                padding: 15px;
                max-width: 210mm; /* A4 width */
            }

            .company-logo {
                max-width: 200px; /* Smaller logo for print */
            }

            .form-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .company-info-small {
                margin-top: 10px;
                font-size: 0.8em;
            }

            .form-section {
                margin-bottom: 15px;
                padding: 10px;
            }

            .form-row {
                gap: 10px;
                margin-bottom: 8px;
            }

            .form-group {
                margin-bottom: 8px;
            }

            input, select, textarea {
                padding: 4px;
                font-size: 0.85em;
            }

            textarea {
                min-height: 40px;
            }

            .line-items {
                margin-bottom: 15px;
            }

            .line-item {
                gap: 8px;
                margin-bottom: 8px;
            }

            .add-item, .remove-item {
                display: none; /* Hide interactive buttons in print */
            }

            .payment-instructions {
                margin-top: 15px;
                padding-top: 10px;
            }

            .payment-instructions ul {
                margin-bottom: 10px;
            }

            .payment-instructions ul li {
                font-size: 0.85em;
                margin-bottom: 3px;
            }

            .payment-disclaimer {
                font-size: 0.8em;
                margin-top: 8px;
            }

            button[type="submit"] {
                display: none; /* Hide submit button in print */
            }

            /* Hide any other unnecessary elements */
            .form-section:empty,
            .form-group:empty {
                display: none;
            }

            /* Ensure page breaks don't occur in the middle of sections */
            .form-section {
                page-break-inside: avoid;
            }
        }

        /* Add compact styles for regular view */
        @media screen {
            .form-container {
                max-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <img src="https://i.ibb.co/M58mL0J/transparent-elite-home.png" alt="Elite Renovation Works Logo" class="company-logo">
            <h1 class="section-title">Generate Estimate</h1>
            <div class="company-info-small">
                <p><strong>Elite Renovation Works</strong></p>
                <p>Jay | 647-563-1314</p>
                <p>jay@eliterenovationworks.ca</p>
                <p>6 Interlacken Way, Markham, ON L3R 5H9</p>
            </div>
        </div>
        
        <form id="estimateForm">
            <!-- Client Information -->
            <div class="form-section">
                <h2 class="section-title">Client Information</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Client Name:</label>
                        <input type="text" name="clientName" required>
                    </div>
                    <div class="form-group">
                        <label>Phone:</label>
                        <input type="tel" name="clientPhone" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" name="clientEmail" required>
                </div>
                <div class="form-group">
                    <label>Street Address:</label>
                    <input type="text" name="clientStreet" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Unit/Suite:</label>
                        <input type="text" name="clientUnit">
                    </div>
                    <div class="form-group">
                        <label>City:</label>
                        <select name="clientCity" required>
                            <option value="">Select City</option>
                            <option value="Markham">Markham</option>
                            <option value="Richmond Hill">Richmond Hill</option>
                            <option value="North York">North York</option>
                            <option value="Scarborough">Scarborough</option>
                            <option value="Toronto">Toronto</option>
                            <option value="Vaughan">Vaughan</option>
                            <option value="Aurora">Aurora</option>
                            <option value="Newmarket">Newmarket</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="otherCityGroup" style="display: none;">
                    <label>Specify City:</label>
                    <input type="text" name="otherCity">
                </div>
                <div class="form-group">
                    <label>Postal Code:</label>
                    <input type="text" name="clientPostal" required pattern="[A-Za-z][0-9][A-Za-z] [0-9][A-Za-z][0-9]">
                </div>
            </div>

            <!-- Project Details -->
            <div class="form-section">
                <h2 class="section-title">Project Details</h2>
                <div class="form-group">
                    <label>Estimate Number:</label>
                    <input type="text" name="estimateNumber" readonly>
                </div>
                <div class="form-group">
                    <label>Service Type:</label>
                    <select name="serviceType" required>
                        <option value="">Select Service</option>
                        <option value="Kitchen Renovation">Kitchen Renovation</option>
                        <option value="Bathroom Renovation">Bathroom Renovation</option>
                        <option value="Painting">Painting</option>
                        <option value="Flooring">Flooring</option>
                        <option value="Drywall">Drywall</option>
                        <option value="Roofing">Roofing</option>
                        <option value="Other">Other (Specify)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Description:</label>
                    <textarea name="projectDescription" rows="4" required></textarea>
                </div>
            </div>

            <!-- Cost Breakdown -->
            <div class="form-section">
                <h2 class="section-title">Cost Breakdown</h2>
                <div class="form-group">
                    <label>Payment Method:</label>
                    <select name="paymentMethod" id="paymentMethod" onchange="updateTaxCalculation()">
                        <option value="regular">E-Transfer</option>
                        <option value="regular">Credit Card</option>
                        <option value="regular">Cheque</option>
                        <option value="regular">Bank Draft</option>
                        <option value="cash">Cash Payment (Tax Free)</option>
                    </select>
                </div>

                <div class="line-items" id="lineItems">
                    <div class="line-item">
                        <label>Description</label>
                        <label>Quantity</label>
                        <label>Unit Price</label>
                        <label>Amount</label>
                        <label></label>
                    </div>
                </div>
                <button type="button" class="add-item" onclick="addLineItem()">+ Add Item</button>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Subtotal:</label>
                        <input type="number" name="subtotal" readonly>
                    </div>
                    <div class="form-group" id="taxSection">
                        <label>HST (13%):</label>
                        <input type="number" name="tax" readonly>
                    </div>
                </div>
                <div class="form-group">
                    <label>Total:</label>
                    <input type="number" name="total" readonly>
                </div>

                <!-- Add Payment Instructions -->
                <div class="payment-instructions">
                    <h3>Payment Schedule:</h3>
                    <ul>
                        <li>First Payment: 1/3 of total amount due upon signing contract</li>
                        <li>Second Payment: 1/3 of total amount due at 50% project completion</li>
                        <li>Final Payment: Remaining balance due upon project completion</li>
                    </ul>
                    <p class="payment-disclaimer">
                        * All payments must be made within 5 business days of reaching each milestone.<br>
                        * Work will commence upon receipt of first payment and signed contract.<br>
                        * Any changes to the scope of work may affect the final price.
                    </p>
                </div>
            </div>

            <button type="submit">Generate Estimate PDF</button>
        </form>
    </div>

    <script>
        // Generate estimate number
        document.addEventListener('DOMContentLoaded', function() {
            function generateEstimateNumber() {
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                const randomNum = Math.floor(Math.random() * (9999 - 1000 + 1) + 1000);
                return `EST-${year}${month}${day}-${randomNum}`;
            }

            document.querySelector('[name="estimateNumber"]').value = generateEstimateNumber();

            // Handle city selection
            const citySelect = document.querySelector('[name="clientCity"]');
            const otherCityGroup = document.getElementById('otherCityGroup');
            const otherCityInput = document.querySelector('[name="otherCity"]');

            citySelect.addEventListener('change', function() {
                if (this.value === 'Other') {
                    otherCityGroup.style.display = 'block';
                    otherCityInput.required = true;
                } else {
                    otherCityGroup.style.display = 'none';
                    otherCityInput.required = false;
                    otherCityInput.value = '';
                }
            });

            // Format postal code
            const postalInput = document.querySelector('[name="clientPostal"]');
            postalInput.addEventListener('input', function() {
                let value = this.value.toUpperCase();
                value = value.replace(/[^A-Z0-9]/g, '');
                if (value.length > 3) {
                    value = value.slice(0, 3) + ' ' + value.slice(3, 6);
                }
                this.value = value;
            });
        });

        // Add line item
        function addLineItem() {
            const container = document.getElementById('lineItems');
            const lineItem = document.createElement('div');
            lineItem.className = 'line-item';
            lineItem.innerHTML = `
                <input type="text" name="description[]" placeholder="Description" required>
                <input type="number" name="quantity[]" placeholder="Qty" min="1" step="1" required>
                <input type="number" name="unitPrice[]" placeholder="Price" step="0.01" required>
                <input type="number" name="amount[]" readonly>
                <button type="button" class="remove-item" onclick="this.parentElement.remove(); calculateTotals();">×</button>
            `;
            container.appendChild(lineItem);

            // Add event listeners for calculation
            const qtyInput = lineItem.querySelector('[name="quantity[]"]');
            const priceInput = lineItem.querySelector('[name="unitPrice[]"]');
            const amountInput = lineItem.querySelector('[name="amount[]"]');

            [qtyInput, priceInput].forEach(input => {
                input.addEventListener('input', () => {
                    const qty = Number(qtyInput.value) || 0;
                    const price = Number(priceInput.value) || 0;
                    amountInput.value = (qty * price).toFixed(2);
                    calculateTotals();
                });
            });
        }

        // Update tax calculation
        function updateTaxCalculation() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const taxSection = document.getElementById('taxSection');
            taxSection.style.display = paymentMethod === 'cash' ? 'none' : 'block';
            calculateTotals();
        }

        // Calculate totals
        function calculateTotals() {
            const amounts = [...document.getElementsByName('amount[]')].map(input => Number(input.value) || 0);
            const subtotal = amounts.reduce((sum, amount) => sum + amount, 0);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const tax = paymentMethod === 'cash' ? 0 : subtotal * 0.13;
            const total = subtotal + tax;

            document.querySelector('[name="subtotal"]').value = subtotal.toFixed(2);
            document.querySelector('[name="tax"]').value = tax.toFixed(2);
            document.querySelector('[name="total"]').value = total.toFixed(2);
        }

        // Update the form submission handler
        document.getElementById('estimateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Generating...';
            
            try {
                // Collect form data
                const formData = new FormData(this);
                const data = Object.fromEntries(formData);
                
                // Send request to generate PDF
                const response = await fetch('http://localhost:3000/api/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        templateType: 'estimation',
                        data: data
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate PDF');
                }

                // Get PDF blob
                const blob = await response.blob();
                
                // Create modal for options
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>Document Generated Successfully</h3>
                        <div class="modal-buttons">
                            <button onclick="printPDF('${URL.createObjectURL(blob)}')" class="print-btn">
                                <i class="fas fa-print"></i> Print Document
                            </button>
                            <button onclick="downloadPDF('${URL.createObjectURL(blob)}', 'estimate-${data.estimateNumber}.pdf')" class="download-btn">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                            <button onclick="closeModal(this)" class="close-btn">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate estimate. Please try again.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Generate Estimate';
            }
        });

        // Helper functions for PDF actions
        function printPDF(url) {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            iframe.contentWindow.print();
        }

        function downloadPDF(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function closeModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html>